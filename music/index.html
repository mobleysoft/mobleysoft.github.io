<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobleysoft Radio</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #111; color: #fff; }
        #genre-list button { margin: 5px; padding: 10px; background: #444; color: white; border: none; cursor: pointer; }
        #genre-list button:hover { background: #666; }
        #player { margin-top: 20px; }
        canvas { width: 100%; height: 200px; background: black; }
        #console-output { margin-top: 20px; color: #0f0; font-size: 14px; text-align: left; padding: 10px; background: #222; border-radius: 5px; max-width: 80%; margin-left: auto; margin-right: auto; }
    </style>
</head>
<body>
    <h1>Mobleysoft Radio</h1>
    <div id="genre-list"></div>
    <div id="player">
        <audio id="audio" controls></audio>
        <button id="next">Next</button>
        <button id="generate-video">Generate Video</button>
    </div>
    <canvas id="visualizer"></canvas>
    <div id="console-output"></div>
    
    <script>
        class MobleysoftMusicPlayer {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
                this.audio = new Audio();
                this.musicData = {};
                this.currentGenre = null;
                this.currentIndex = 0;
                this.canvas = document.getElementById("visualizer");
                this.ctx = this.canvas.getContext("2d");
                this.analyser = null;
                this.dataArray = null;
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.consoleOutput = document.getElementById("console-output");
                this.init();
            }

            logMessage(message) {
                this.consoleOutput.innerHTML += `<p>${message}</p>`;
                console.log(message);
            }

            async init() {
                this.logMessage("Initializing player...");
                await this.loadMusicData();
                this.setupGenres();
                this.setupVisualizer();
                document.getElementById("next").addEventListener("click", () => this.playNext());
                document.getElementById("generate-video").addEventListener("click", () => this.generateVideo());
            }

            async loadMusicData() {
                try {
                    this.logMessage("Fetching site directory...");
                    let response = await fetch(`${this.baseUrl}/site-directory.json`);
                    if (!response.ok) throw new Error("Site directory not found");
                    const siteData = await response.json();
                    
                    if (siteData.music) {
                        this.musicData = {};
                        Object.keys(siteData.music).forEach(genre => {
                            this.musicData[genre] = Object.keys(siteData.music[genre]);
                        });
                        this.logMessage("Music data loaded successfully.");
                    }
                } catch (error) {
                    this.logMessage("Failed to load site directory, attempting to regenerate...");
                    await fetch(`${this.baseUrl}/.github/scripts/generate-site-directory.js`).catch(err => this.logMessage("Error running generate script: " + err));
                }
            }

            setupGenres() {
                const genreList = document.getElementById("genre-list");
                Object.keys(this.musicData).forEach(genre => {
                    const button = document.createElement("button");
                    button.textContent = genre;
                    button.addEventListener("click", () => this.playGenre(genre));
                    genreList.appendChild(button);
                });
                this.logMessage("Genres loaded.");
            }

            playGenre(genre) {
                this.logMessage(`Playing genre: ${genre}`);
                this.currentGenre = genre;
                this.currentIndex = 0;
                this.playNext();
            }

            playNext() {
                if (!this.currentGenre) {
                    this.logMessage("No genre selected.");
                    return;
                }
                const tracks = this.musicData[this.currentGenre];
                if (tracks.length === 0) {
                    this.logMessage("No tracks available in this genre.");
                    return;
                }
                this.currentIndex = (this.currentIndex + 1) % tracks.length;
                this.audio.src = `${this.baseUrl}/music/${this.currentGenre}/${tracks[this.currentIndex]}`;
                this.audio.play();
                this.logMessage(`Playing track: ${this.audio.src}`);
            }
        }

        const player = new MobleysoftMusicPlayer("https://mobleysoft.com");
    </script>
</body>
</html>
